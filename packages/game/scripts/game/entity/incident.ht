import '../game.ht'
import 'character.ht'

/// 历史事件记录
struct Incident {
  construct ({
    content: str,
    
    isPublic = true,
    isGlobal = false,

    order = 0,
    ideal = 0,
    good = 0,
    
    subjectId: str,
    toCharacterIds: List,
    withItem: str,
    toItem: str,
    siteId: str,
    terrainIndex: int,
  }) {
    assert(content != null && content.isNotEmpty)
    assert(subjectId != null)
    this.index = history.length

    this.content = content
    this.timestamp = game.timestamp

    this.order = order
    this.ideal = ideal
    this.good = good

    this.subjectId = subjectId
    this.toCharacterIds = toCharacterIds
    this.withItem = withItem
    this.toItem = toItem
    this.siteId = siteId
    this.terrainIndex = terrainIndex

    final subject = game.characters[subjectId]
    subject.experiencedIncidentIndexes.add(this.index)

    this.isPublic = isPublic
    this.isGlobal = isGlobal

    if (isPublic) {
      if (isGlobal) {
        for (final char of game.characters) {
          if (char.id == subjectId) continue
          characterHeardOfIncident(char, this)
        }
      }
    }

    history.add(this)
  }
}

fun getIncidentByIndex(index: int) {
  return history[index]
}
